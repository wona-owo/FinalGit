<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="member">

		
	<!-- 회원가입 -->
	<insert id="insertUser"
	parameterType="member">
	
	insert into tbl_user 
	(user_no, 
	 user_id, 
	 user_pw, 
	 user_nickname, 
	 user_name, 
	 user_address, 
	 user_email, 
	 user_phone) 
	values 
	(seq_user.nextval, 
	 #{userId}, 
	 #{userPw}, 
	 #{userNickname}, 
	 #{userName}, 
	 #{userAddress}, 
	 #{userEmail}, 
	 #{userPhone})
	 	
	</insert>

	<!-- 로그인 -->
	<select id="loginMember" parameterType="member" resultType="member">
		select user_no as userNo,
           	   user_id as userId,
           	   user_pw as userPw,
           	   user_nickname as userNickname,
               user_name as userName,
               user_address as userAddress,
               user_email as userEmail,
               user_phone as userPhone,
               user_type as userType,
               enroll_date as enrollDate,
               acct_level as acctLevel,
               ban_yn as banYN, 
               user_image as userImage
          from tbl_user
    	where user_id = #{userId} and user_pw = #{userPw}
	</select>
	
   <!-- ID 중복 확인 -->
   <select id="idDuplChk"
   parameterType="string"
   resultType="_int">
	  select count(*)
	  from tbl_user
	  where user_id = #{_parameter}
   </select>
  
   <!-- 닉네임 중복 확인 -->
   <select id="nickDuplChk"
   parameterType="string"
   resultType="_int">
	  select count(*)
	  from tbl_user
	  where user_nickname = #{_parameter}
   </select>
  
   <!-- 전화번호 중복 확인 -->
   <select id="phoneDuplChk"
   parameterType="string"
   resultType="_int">
	  select count(*)
	  from tbl_user
	  where user_phone = #{_parameter}
   </select>

	<!-- API 회원가입 -->
	<insert id="insertApiUser"
	parameterType="member">
		insert into tbl_user 
		(user_no, 
		 user_id, 
		 user_pw, 
		 user_nickname, 
		 user_name, 
		 user_address, 
		 user_email, 
		 user_phone,
		 user_type) 
		values 
		(seq_user.nextval, 
		 #{userId}, 
		 #{userPw}, 
		 #{userNickname}, 
		 #{userName}, 
		 #{userAddress}, 
		 #{userEmail},
		 #{userPhone},
		 #{userType})
	</insert>
	
	<select id="userSearch" parameterType="string" resultType="member">
		<![CDATA[
	        SELECT * FROM (
	            SELECT user_no AS userNo,
	                   user_id AS userId,
	                   user_nickname AS userNickname,
	                   user_name AS userName,
	                   user_image AS userImage
	            FROM tbl_user
	            WHERE UPPER(user_id) LIKE '%' || UPPER(#{search}) || '%'
	               OR UPPER(user_name) LIKE '%' || UPPER(#{search}) || '%'
	               OR UPPER(user_nickname) LIKE '%' || UPPER(#{search}) || '%'
	            ORDER BY user_name ASC
	        )
	        WHERE ROWNUM <= 5
    	]]>
	</select>
	
	<select id="tagSearch" parameterType="string" resultType="hashTag">
		 <![CDATA[
            SELECT * FROM (
                SELECT 
                    hash_name AS hashName,
                    COUNT(post_no) AS postCount
                FROM HASHTAG
                WHERE LENGTH(#{search}) > 0
                  AND UPPER(hash_name) LIKE '%' || UPPER(#{search}) || '%'
                GROUP BY hash_name
                ORDER BY hash_name DESC
            )
            WHERE ROWNUM <= 5
        ]]>
	</select>
	
	<update id="updateKeyword" parameterType="map">
		update search
			set keyword_date = SYSDATE
			where user_no = #{userNo}
		and keyword = #{keyword}
	</update>
	
	<insert id="insertKeyword" parameterType="map">
		insert into search (user_no, keyword)
    	values (#{userNo}, #{keyword})
	</insert>
	
	<delete id="userDelete"
	parameterType="string">
	delete from tbl_user
		  where user_id = #{_parameter}
	</delete>
	
	<select id="searchHashTagsKeyword" parameterType="string" resultType="hashTag">
		SELECT hash_name AS hashName,
       		   COUNT(post_no) AS postCount
		  FROM HASHTAG
		WHERE UPPER(hash_name) LIKE '%' || UPPER(#{search}) || '%'
		GROUP BY hash_name
		ORDER BY COUNT(post_no)DESC
	</select>
	
	<select id="searchUsersKeyword" parameterType="string" resultType="member">
		SELECT user_no AS userNo,
	           user_id AS userId,
	           user_nickname AS userNickname,
	           user_name AS userName,
	           user_image AS userImage
    	  FROM tbl_user
    	WHERE UPPER(user_id) LIKE '%' || UPPER(#{search}) || '%'
	       OR UPPER(user_name) LIKE '%' || UPPER(#{search}) || '%'
	       OR UPPER(user_nickname) LIKE '%' || UPPER(#{search}) || '%'
	    ORDER BY user_name ASC
	</select>
</mapper>
